<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bob's 27 Darts Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* CRITICAL: Align content to the top edge */
            min-height: 100vh;
            padding: 20px;
        }
        .calculator-container {
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            background-color: white;
            border-radius: 1.5rem;
            overflow: hidden;
        }
        .keypad button {
            transition: transform 0.1s, box-shadow 0.1s;
            background-color: #3b82f6; /* Blue for Hits */
            color: white;
            font-size: 1.75rem; 
            font-weight: 900;
            border-radius: 0.75rem;
            padding: 1.25rem 0;
            box-shadow: 0 4px #2563eb;
        }
        /* Specific style for the large 0 Miss button */
        .keypad button.miss-button {
            background-color: #4b5563; /* Darker Gray for Miss/Penalty */
            box-shadow: 0 4px #1f2937;
            padding: 1.5rem 0; /* Extra padding for height */
            font-size: 2rem;
        }
        .keypad button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #2563eb;
        }
        .keypad button.miss-button:active {
            box-shadow: 0 2px #1f2937;
        }
        
        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed to align to top */
            padding-top: 10vh; /* Added padding to position it below the top edge */
            z-index: 100;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Mobile Optimization for Full Screen Fit (100vh) */
        @media (max-width: 640px) {
            body {
                padding: 0; /* Remove body padding on small screens */
                height: 100vh; /* Set explicit height */
                overflow: hidden; /* Prevent page scrolling */
            }
            .calculator-container {
                border-radius: 0; /* Remove border-radius */
                box-shadow: none; /* Remove shadow */
                max-width: 100%; /* Ensure full width */
                height: 100%; /* Take 100% of body height */
                display: flex; /* Enable flexbox */
                flex-direction: column; /* Stack children vertically */
            }
            
            /* Ensure fixed-size elements don't shrink */
            .calculator-container > div {
                flex-shrink: 0;
            }
            
            .game-over-modal {
                /* Adjust padding for a slightly tighter fit on small screens */
                padding-top: 8vh;
            }
        }
        
        /* Specific adjustments for small screens in landscape mode */
        @media (max-width: 768px) and (orientation: landscape) {
            body {
                padding: 5px; /* Add small padding back for visual margin */
            }
            .calculator-container {
                max-height: 100vh; /* Ensure it respects viewport height */
                /* Reduce the max-width slightly to allow more height if needed, but keeping it fixed for layout stability */
            }
            /* Reduce padding in header/score area */
            .calculator-container > .p-6 {
                padding: 1rem;
            }
            /* Reduce button sizes in the keypad */
            .keypad button {
                font-size: 1.25rem; 
                padding: 0.8rem 0; 
                border-radius: 0.5rem;
            }
            .keypad button.miss-button {
                font-size: 1.5rem; 
                padding: 1rem 0; 
            }
            /* Reduce undo button padding */
            #undoButton {
                 padding-top: 0.5rem;
                 padding-bottom: 0.5rem;
                 font-size: 0.875rem; /* text-sm */
            }
            /* Reduce overall internal section padding */
            .calculator-container > .p-4 {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>

<div class="calculator-container">
    <!-- Header/Display Area (Fixed Height) -->
    <div class="p-6 bg-gray-900 text-white">
        <!-- Current Target -->
        <div id="targetDisplay" class="text-2xl font-black text-blue-300 mb-2 text-center">
            --
        </div>
        <!-- Current Score -->
        <div class="text-sm font-light text-gray-400">Current Score</div>
        <div id="scoreDisplay" class="text-6xl font-extrabold text-right transition-all duration-300">
            27
        </div>
    </div>

    <!-- Input Area (Fixed Height) -->
    <div class="p-4 border-b border-gray-200">
        <!-- NEW UNDO BUTTON -->
        <div class="flex justify-center">
             <button id="undoButton" onclick="undoRound()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                Undo Last Round
             </button>
        </div>
        
        <div id="inputDisplay" class="text-4xl text-center font-black text-gray-800 p-2 bg-gray-100 rounded-lg shadow-inner hidden">
            <!-- This is now hidden as input and round advance is instantaneous -->
        </div>
    </div>

    <!-- Keypad (Fills Remaining Space on Mobile, allows internal scrolling if needed) -->
    <div class="p-4 flex-grow overflow-y-auto">
        <div class="grid grid-cols-3 gap-4 keypad">
            <!-- Top Row: 1, 2, 3 -->
            <button onclick="handleKeyClick(1)">1 Hit</button>
            <button onclick="handleKeyClick(2)">2 Hits</button>
            <button onclick="handleKeyClick(3)">3 Hits</button>
            
            <!-- Bottom Row: 0 (Spanning 3 columns) -->
            <button onclick="handleKeyClick(0)" class="col-span-3 miss-button">0 Miss</button>
        </div>
    </div>
    
    <!-- Game Stats (Fixed Height) -->
    <div class="p-4 text-center text-sm text-gray-500 border-t border-gray-100">
        <span id="roundsCompleted">Round 1/21</span> | <span id="currentTargetValue">D1 Value: 2 Points</span>
    </div>

    <!-- Footer (Fixed Height) -->
    <div class="p-2 text-center text-xs text-gray-400 bg-gray-50 border-t border-gray-100">
        Created and Designed by **MDStudios** for **CGCDarts.com** Â© 2025 cgcdarts.com | All Rights Reserved.
    </div>

</div>

<!-- Game Over Modal (Hidden by default) -->
<div id="gameOverModal" class="game-over-modal hidden">
    <div class="modal-content">
        <h2 id="gameOverTitle" class="text-3xl font-black text-red-600 mb-3">Game Over!</h2>
        <p id="gameOverMessage" class="text-xl text-gray-700 mb-4">
            You finished with a score of <span id="finalScore" class="font-extrabold text-4xl text-blue-600">--</span>.
        </p>
        <button onclick="resetGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
            Play Again?
        </button>
    </div>
</div>

<script>
    // --- Game State Variables ---
    let score = 27;
    let currentRoundIndex = 0;
    let isGameOver = false;

    // History to store the state before the last score change
    // Initial state is score: 27, roundIndex: 0
    let history = { score: 27, roundIndex: 0 }; 

    // Targets: D1 through D20, followed by Bullseye (D25). Total 21 rounds.
    const targets = [
        { val: 1, name: 'Double 1' }, { val: 2, name: 'Double 2' }, { val: 3, name: 'Double 3' },
        { val: 4, name: 'Double 4' }, { val: 5, name: 'Double 5' }, { val: 6, name: 'Double 6' },
        { val: 7, name: 'Double 7' }, { val: 8, name: 'Double 8' }, { val: 9, name: 'Double 9' },
        { val: 10, name: 'Double 10' }, { val: 11, name: 'Double 11' }, { val: 12, name: 'Double 12' },
        { val: 13, name: 'Double 13' }, { val: 14, name: 'Double 14' }, { val: 15, name: 'Double 15' },
        { val: 16, name: 'Double 16' }, { val: 17, name: 'Double 17' }, { val: 18, name: 'Double 18' },
        { val: 19, name: 'Double 19' }, { val: 20, name: 'Double 20' }, { val: 25, name: 'Bullseye' } // Bullseye is scored as D25
    ];

    // --- DOM Elements ---
    const scoreDisplay = document.getElementById('scoreDisplay');
    const targetDisplay = document.getElementById('targetDisplay');
    const roundsCompleted = document.getElementById('roundsCompleted');
    const currentTargetValue = document.getElementById('currentTargetValue');
    const gameOverModal = document.getElementById('gameOverModal');
    const gameOverTitle = document.getElementById('gameOverTitle');
    const gameOverMessage = document.getElementById('gameOverMessage');

    // --- Utility Functions ---

    /** Updates the visible score and target on the UI. */
    function updateUI() {
        // Update Score Display colors
        scoreDisplay.textContent = score;
        scoreDisplay.classList.toggle('text-red-500', score <= 0);
        scoreDisplay.classList.toggle('text-yellow-500', score > 0 && score <= 10);
        scoreDisplay.classList.toggle('text-white', score > 10 && !isGameOver);
        
        // Ensure score is red/blue if game is over
        if (isGameOver) {
             scoreDisplay.classList.remove('text-white', 'text-yellow-500');
             scoreDisplay.classList.add(score <= 0 ? 'text-red-500' : 'text-blue-500');
        }

        // Update Target Display
        if (currentRoundIndex < targets.length) {
            const currentTarget = targets[currentRoundIndex];
            const roundNumber = currentRoundIndex + 1;
            const pointsPerHit = currentTarget.val * 2;
            const pointsLost = currentTarget.val * 2; // Penalty is the double's value

            targetDisplay.textContent = currentTarget.name;
            roundsCompleted.textContent = `Round ${roundNumber}/${targets.length}`;
            currentTargetValue.textContent = `Hit: +${pointsPerHit} | Miss: -${pointsLost}`;
        } else {
            targetDisplay.textContent = 'GAME OVER';
        }
    }

    /**
     * Handles clicks on the number pad (0, 1, 2, 3), calculates the score change, and advances the round.
     * @param {number} dartsHit - The number of darts that hit the double (0-3).
     */
    window.handleKeyClick = function(dartsHit) {
        if (isGameOver) return;
        
        // 1. Save current state to history BEFORE calculation/advance
        history.score = score;
        history.roundIndex = currentRoundIndex;
        
        // 2. Calculate and apply score change
        const currentTarget = targets[currentRoundIndex];
        const pointValue = currentTarget.val * 2;
        let scoreChange = 0;

        if (dartsHit > 0) {
            // Reward: Add points per hit.
            scoreChange = dartsHit * pointValue;
        } else {
            // Penalty: Subtract the point value (double's value) if all 3 darts miss.
            scoreChange = -pointValue;
        }

        score += scoreChange;

        // 3. Advance to the next round
        currentRoundIndex++;

        // 4. Check for game end conditions
        checkGameEnd();
        
        // 5. Update UI for the new state
        updateUI();
    }

    /** Undoes the last score change, reverting score and round index. */
    window.undoRound = function() {
        // Check if we are already at the starting state (score 27, round 0) and cannot undo further
        if (currentRoundIndex === 0 && score === 27) {
            console.log("Cannot undo past the start of the game.");
            return;
        }

        // Restore the state from history
        score = history.score;
        currentRoundIndex = history.roundIndex;
        isGameOver = false; // Clear game over state if undoing an action

        // Hide the game over modal if it was visible
        gameOverModal.classList.add('hidden');
        
        // Update UI
        updateUI();
    }

    /** Checks if the game has ended and displays the modal if so. */
    function checkGameEnd() {
        if (score <= 0) {
            isGameOver = true;
            
            // Set modal for Bust
            gameOverTitle.textContent = "Game Over!"; 
            gameOverTitle.classList.remove('text-blue-600');
            gameOverTitle.classList.add('text-red-600');
            gameOverMessage.innerHTML = `You busted! Your score dropped to or below zero. Final Score: <span class="font-extrabold text-4xl text-red-600">${score}</span>.`;
            
            gameOverModal.classList.remove('hidden');

        } else if (currentRoundIndex >= targets.length) {
            isGameOver = true;
            
            // Set modal for Completion
            gameOverTitle.textContent = "Game Complete!";
            gameOverTitle.classList.remove('text-red-600');
            gameOverTitle.classList.add('text-blue-600');
            gameOverMessage.innerHTML = `Congratulations! You successfully completed all targets. Final Score: <span class="font-extrabold text-4xl text-blue-600">${score}</span>.`;
            
            gameOverModal.classList.remove('hidden');
        }
    }

    /** Resets the game state and UI. */
    window.resetGame = function() {
        score = 27;
        currentRoundIndex = 0;
        isGameOver = false;
        // Reset history to initial state as well
        history = { score: 27, roundIndex: 0 }; 

        gameOverModal.classList.add('hidden');
        updateUI();
    }

    // --- KEYBOARD HOTKEYS ---
    document.addEventListener('keydown', function(event) {
        // Allow 'Enter' or 'R' key to quickly reset the game from the modal
        if (isGameOver && (event.key === 'Enter' || event.key.toLowerCase() === 'r')) {
             resetGame();
             return;
        }
        
        // Undo Hotkey (Backspace or U)
        if (event.key === 'Backspace' || event.key.toLowerCase() === 'u') {
            event.preventDefault();
            undoRound();
            return;
        }

        if (isGameOver) return;

        const key = event.key;
        let dartsHit = -1; // Initialize to an invalid value

        // Check for main keyboard row digits ('1', '2', '3', '0')
        // Check for Numpad digits ('Numpad1', 'Numpad2', 'Numpad3', 'Numpad0')
        if (key === '1' || event.code === 'Numpad1') {
            dartsHit = 1;
        } else if (key === '2' || event.code === 'Numpad2') {
            dartsHit = 2;
        } else if (key === '3' || event.code === 'Numpad3') {
            dartsHit = 3;
        } else if (key === '0' || event.code === 'Numpad0') {
            dartsHit = 0;
        }

        if (dartsHit !== -1) {
            // Prevent default browser action (like scrolling) for key presses
            event.preventDefault();
            handleKeyClick(dartsHit);
        }
    });

    // Initialize the game on load
    window.onload = updateUI;

</script>

</body>
</html>